#!/usr/bin/env ruby

ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../../Gemfile', __FILE__)

require 'rubygems'
require 'bundler'
Bundler.setup
require 'thor'
require 'hobson'

Class.new Thor do

  def initialize *args
    super
    ARGV.shift
  end

  desc "console", "start an interactive ruby console"
  def console
    require 'ruby-debug'
    require 'irb'
    IRB.start
  end

  desc "test", "tell Hobson to run the tests for the current sha"
  def test
    test_run = Hobson::Project.current.run_tests!
    puts "starting test run #{test_run.id} for #{test_run.sha}"
    Hobson::Server.start! :launch_path => "/projects/#{test_run.project.name}/test_runs/#{test_run.id}"
  end

  desc "work", "become a test running worker"
  method_options %w( demonize -d ) => false, :banner => 'deamonize before becoming a resque worker'
  def work
    if options.demonize?
      require 'daemons'
      Daemons.daemonize(
        :dir_mode   => :script,
        :dir        => Hobson.root,
        :ontop      => false,
        :app_name   => 'hobson',
        :log_output => true,
        :log_dir    => Hobson.log.parent
      )
      puts "daemonized PID: #{Process.pid} AT: #{Time.now}"
    end
    Hobson.work!
  end

  desc "web", "start hobson web server (see vegas options)"
  method_options %w( help -h ) => false, :banner => 'show vegas help for more options'
  def web
    Hobson::Server.start!
  end

  desc "resque-web", "start resque-web"
  method_options %w( help -h ) => false, :banner => 'show vegas help for more options'
  def resque_web
    require 'vegas'
    require 'resque/server'
    Resque::Server.set :protection, :except => :frame_options
    Vegas::Runner.new(Hobson.resque::Server, 'hobson-resque-web')
  end

end.start
